---
# Pre-installation tasks
- name: Ensure system directories exist
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    mode: "0755"
    owner: root
    group: root
  loop:
    - { path: "{{ mdatp_paths.install_dir }}" }
    - { path: "/etc/apt/trusted.gpg.d", when: ansible_os_family == 'Debian' }
    - { path: "/etc/pki/rpm-gpg", when: ansible_os_family == 'RedHat' }
  when: "item.when | default(true)"
  tags: 
    - install
    - directories

- name: Download Microsoft signing key
  ansible.builtin.get_url:
    url: "{{ mdatp_repository.key_url }}"
    dest: "{{ item.dest }}"
    mode: "0644"
    force: true
  with_items:
    - { dest: "/etc/apt/trusted.gpg.d/microsoft.asc", when: ansible_os_family == "Debian" }
    - { dest: "/etc/pki/rpm-gpg/microsoft.asc", when: ansible_os_family == "RedHat" }
  when: item.when | bool
  register: key_download
  until: key_download is success
  retries: 3
  delay: 5
  tags:
    - install
    - repository

# Repository setup for different distributions
- name: Set up repository for Debian-based systems
  block:
    - name: Add Microsoft repository for Ubuntu
      ansible.builtin.apt_repository:
        repo: "{{ debian_family.repository.ubuntu.template }}"
        filename: microsoft-prod
        state: "{{ mdatp_repository.state }}"
        update_cache: true
      register: repo_add
      until: repo_add is success
      retries: 3
      delay: 5
      when: ansible_distribution == "Ubuntu"
    
    - name: Add Microsoft repository for Debian
      ansible.builtin.apt_repository:
        repo: "{{ debian_family.repository.debian.template }}"
        filename: microsoft-prod
        state: "{{ mdatp_repository.state }}"
        update_cache: true
      register: repo_add
      until: repo_add is success
      retries: 3
      delay: 5
      when: ansible_distribution == "Debian"
  when: ansible_os_family == "Debian"
  tags:
    - install
    - repository

- name: Set up repository for RedHat-based systems
  block:
    - name: Import Microsoft key for RedHat-based systems
      ansible.builtin.rpm_key:
        key: "/etc/pki/rpm-gpg/microsoft.asc"
        state: present
      register: key_import
      until: key_import is success
      retries: 3
      delay: 5

    - name: Add Microsoft repository for RedHat-based systems
      ansible.builtin.yum_repository:
        name: "{{ redhat_family.repository.template.name }}"
        description: "Microsoft Defender for Endpoint"
        baseurl: "https://packages.microsoft.com/rhel/{{ ansible_distribution_major_version }}/prod/"
        gpgkey: "{{ mdatp_repository.key_url }}"
        gpgcheck: true
        enabled: "{{ mdatp_repository.enabled }}"
        state: "{{ mdatp_repository.state }}"
      register: repo_add
      until: repo_add is success
      retries: 3
      delay: 5
  when: ansible_os_family == "RedHat"
  tags:
    - install
    - repository

# Package installation
- name: Install MDATP package
  ansible.builtin.package:
    name: "{{ mdatp_package.name }}"
    state: "{{ mdatp_package.state }}"
    update_cache: "{{ ansible_os_family == 'Debian' }}"
  register: package_install
  until: package_install is success
  retries: 3
  delay: 5
  notify: restart mdatp
  tags:
    - install
    - package

# Post-installation configuration
- name: Configure MDATP service
  ansible.builtin.service:
    name: mdatp
    enabled: true
    state: started
  when: mdatp_package.state != 'absent'
  tags:
    - install
    - service
